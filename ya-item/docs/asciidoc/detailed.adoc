
== DSPM用户模块详细设计文档

=== 人员分配

[%header,cols="1,1"]
|===
|姓名 |职责

|刘江
|负责人

|王斌
|负责人

|===

=== 总体方案确认

总体模块划分如下：

image::/images/user.png[总体架构图]

本项目负责用户模块，与消息推送模块有交互

=== 运行环境

[%header,cols="1,1"]
|===
|软件名 |版本

|OpenJDK
|11

|Maven
|4.0

|MongoDB
|4.2

|===

=== 模块结构说明

本模块可以细分为如下功能：

[plantuml,structure,svg]
----
@startmindmap

* 用户管理
** 注册功能
** 登录功能
** 修改个人信息功能
** 信息绑定功能
** 忘记密码功能
** 修改密码功能
** 头像上传功能
@endmindmap
----

=== 模块调用流程和顺序

==== 用户部分

通常情况下的调用逻辑如下图所示

[plantuml,user-sequence,svg]
----
@startuml
用户 -> 网关: 请求内容
网关 -> 用户管理服务: 请求转发
用户管理服务 -> 用户: 请求结果
网关 -> 用户: 结果转发
@enduml
----

但是在微信登录的过程中的逻辑如下所示：

[plantuml,wechat-sequence,svg]
----
用户 -> 微信: 扫码
微信 -> 前端: 第三方登录信息
前端 -> 网关: 请求内容
网关 -> 用户管理服务: 请求转发
用户管理服务 -> 网关: 请求结果
网关 -> 用户: 结果转发
----

=== 功能模块实现设计

==== 注册功能

输入：

在使用手机或者邮箱的时候可以使用如下内容进行注册：

- 手机/邮箱
- 密码
- 验证码

在使用微信登录的情况下需要输入：

- 微信登录信息

输出：

- 注册结果信息

逻辑：

[plantuml,register,svg]
----
@startuml
start
:用户发起注册请求;
if(用户输入了合法的手机号/邮箱) then (是)
            if (用户输入的手机号/邮箱并未进行过注册) then (是)
                :请求消息推送模块;
                :验证码发送;
 :填入验证码;
    if (验证码填写正确) then (是)
        :使用输入信息完成注册;
        :加密用户密码;
        stop
    else (否)
        :返回验证码不正确;
        end
    endif
            else (否)
                :返回此手机/邮箱已经被注册;
                end
            endif
        else (否)
            :返回用户输入电话/邮箱地址有误;
            end
        endif


@enduml
----

权限：

无

备注：

无

==== 用户登录功能

输入：

使用账号和密码的情况下需要输入：

- 手机/邮箱
- 密码

输出：

- 用户令牌

逻辑：

[plantuml,login,svg]
----
@startuml
start
:输入登录信息;

    if (存在相应手机号/邮箱) then (是)
        if (用户输入密码正确) then (是)
            if (账户被禁用) then (是)
                :返回该用户状态异常;
                end
            endif
            :登陆成功;
stop
        else (否)
            :返回密码输入错误;
            end
        endif
    else (否)
        :返回该用户不存在;
        end

@enduml
----

权限：

无

备注：

无







==== 用户微信登录功能

输入：


在使用微信登录的情况下需要输入：

- 微信登录信息

输出：

- 用户令牌

逻辑：

[plantuml,wechat_login,svg]
----
@startuml

:微信扫码;
:获取微信登录信息;
if(数据库中存在对应用户信息) then(是)
:使用数据库中的对应信息完成登录;
else(否)
:使用此微信的基础信息完成账号注册;
:登录;

@enduml
----

权限：

无

备注：

无





==== 修改个人信息功能

输入：

- 个人信息

输出：

- 修改结果

逻辑：

[plantuml,update,svg]
----
@startuml
start
:输入修改信息;
if (修改信息符合规范) then (是)
    :修改个人信息;
    :
返回修改结果;
    stop
else (否)
    :返回修改内容填写错误;
    end
endif
@enduml
----

权限：

此处接口需要普通用户权限

备注：

无

==== 微信绑定

输入：

- 输入用户id

输出：

- 绑定结果

逻辑：
[plantuml,bindWechat,svg]
----
@startuml
start
:用户点击绑定微信;
if(用户状态异常) then(否)
:用户扫码授权;
:存储微信用户个人信息;
if(该微信账号已经绑定) then(否)
:绑定微信;
stop
else (是)
:该微信已经被绑定;
end
endif
else (是)
:返回用户状态异常;
end
@enduml
----

权限：

此处接口需要普通用户权限

备注：

无

==== 绑定邮箱/手机功能

输入：

- 绑定的手机号/邮箱、验证码

输出：

- 绑定结果

逻辑：

[plantuml,bindPhone,svg]
----
@startuml
start
:用户点击手机绑定;
if(手机/邮箱格式校验通过) then(是)
if(验证码校验通过) then(是)
if(该手机号/邮箱是否已经被绑定) then(否)
:绑定手机号/邮箱;
stop
else(是)
:该手机号/邮箱已经被绑定;
end
endif
else(否)
:验证码校验失败;
end
endif
else(否)
:手机/邮箱格式错误;
end
@enduml
----

权限：

此处接口需要普通用户权限

备注：

无


==== 找回密码功能

输入：

- 手机号、验证码、新密码

输出：

无

逻辑：

[plantuml,restPassword,svg]
----
@startuml
start
:传入手机号、验证码、新密码;
if(校验手机号是否合法) then(是)
if(校验验证码) then(通过)
:查询该用户;
:加密密码;
:保存新密码;
stop
else(不通过)
:校验验证码失败;
end
endif
else(否)
:输入的手机号码不合法;
end
@enduml
----


==== 修改密码功能

输入：

- 手机号、验证码、新密码

输出：

无

逻辑：

[plantuml,putPassword,svg]
----
@startuml
start
:传入用户id、旧密码、新密码;
:查询该用户;
if(旧密码合法) then(是)
if(校验新密码输入格式) then(通过)
:加密密码;
:保存新密码;
stop
else(不通过)
:校验失败，返回;
end
endif
else(否)
:输入密码不合法;
end
@enduml
----


==== 头像上传功能

输入：

- 头像文件

输出：

- 头像地址

逻辑：

[plantuml,User,svg]
----
@startuml
start
:传入头像文件;
:存储头像文件;
:返回头像地址;
end
@enduml
----

=== 数据库设计

本项目默认采用 dscm 库

==== user表

[%header,cols="1,1,1"]
|===
|列名 |数据类型 |中文说明

|id
|String
|用户唯一ID

|username
|String
|用户昵称

|password
|String
|用户密码

|avatarUrl
|String
|用户头像

|email
|String
|邮箱

|mobile
|String
|手机号

|weChatInfo
|WeChat 模型
|微信登录信息

|weChatUnionID
|String
|微信标识

|status
|Integer
|用户状态

|roles
|List<role>
|权限列表

|lastLoginAt
|LocalDateTime
|最后一次登录时间

|createdAt
|LocalDateTime
|用户建立时间

|updatedAt
|LocalDateTime
|账号信息更新时间

|deletedAt
|LocalDateTime
|账号删除时间

|deleted
|Boolean
|已删除标识

|===

.WeChat 模型
[%header,cols="1,1,1"]
|===
|列名 |数据类型 |中文说明

|weChatOpenid
|String
|微信 Openid

|weChatNickname
|String
|微信昵称

|weChatSex
|String
|微信中的性别

|weChatProvince
|String
|微信中的所在省份

|weChatCity
|String
|微信中的所在城市

|weChatCountry
|String
|微信中的所在国家

|weChatHeadImgUrl
|String
|微信头像

|weChatPrivilege
|List<String>
|微信授权信息

|weChatUnionID
|String
|微信用户统一标识

|===

=== 类的设计和说明

==== 用户部分

类图:

image::/images/类图.png[类图]


类名及其作用对应表如下：

[%header,cols="1,1"]
|===
|类名 |作用

|RegisterOrRestView
|用户注册视图属性类，提供密码、code、key属性

|LoginView
|用户登陆视图属性类，提供密码、账号属性

|BindingEmailOrPhoneView
|邮箱or电话绑定视图属性类，提供code、key、userId属性

|BindingWeChat
|微信绑定属性类，提供type、code、state、userId等属性

|ResetPassWordView
|密码重置视图属性类，提供密码、修改后新密码属性

|TokenInfo
|token转换类

|UpdatePassword
|修改密码模型类

|UpdateUserDto
|用户信息修改转换类

|UserDto
|用户转换类

|WeChatInfo
|用户微信属性类

|BasicPage
|分页封装类

|DataSets
|数据设置类

|EmailEntity
|邮箱属性类

|SendMail
|邮箱发送属性类

|SendMailAll
|全部邮箱用户属性类

|SmsEntity
|短信属性类

|UploadFile
|上传属性类

|User
|用户属性类

|AuthService
|认证业务层

|EmailService
|邮箱业务层

|SmsService
|短信业务层

|UserService
|用户业务层

|WeChatService
|微信业务层

|AuthServiceImpl
|认证业务实现类

|EmailServiceImpl
|邮箱业务实现类

|RedisTemplateService
|redis业务层

|SmsServiceImpl
|短信业务实现类

|UserServiceImpl
|用户业务实现类

|WeChatServiceImpl
|微信业务实现类

|AuthUserController
|认证web访问层

|GlobalExceptionController
|全局异常web访问层

|OperateETController
|邮箱模板配置web访问层

|OperateSTController
|短信模板配置web访问层

|SendMessageController
|消息发送web访问层

|UserController
|用户web访问层

|WxApiController
|微信登录web访问层

|CommonResult
|自定义返回类型

|CustomException
|自定义异常类

|GlobalExceptionHandler
|全局异常拦截类

|IErrorCode
|异常状态码

|ResultCode
|返回状态码

|MongoConfig
|mongoDB配置类

|OpenApi3Config
|OpenApi3配置类

|RedisConfig
|redis配置类

|RestTemplateConfig
|http请求配置类

|WebSecurityConfig
|Security配置类

|WechatAccountConfig
|微信配置类

|HttpClientUtils
|http请求工具类

|JsonUtils
|json工具类

|MessageUtil
|内容工具类

|OrderType
|排序规则

|PageableAndSortRequest
|排序分页工具类

|PageTag
|分页工具类

|UploadUtil
|上传工具类

|UserUtil
|用户工具类

|UserApplication
|程序入口

|===

=== 参考资料

https://docs.spring.io/spring-data/mongodb/docs/3.0.3.RELEASE/reference/html/[Spring Data MongoDB 官方文档]

